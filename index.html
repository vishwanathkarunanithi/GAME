<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Assembly Kombat: IPL Edition</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@600&family=Roboto:wght@700&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body { margin: 0; background: #050505; font-family: 'Roboto', sans-serif; overflow: hidden; color: white; }

        /* --- SCREENS --- */
        .screen { display: none; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; flex-direction: column; }
        .active { display: flex; }

        /* --- 1. MENU SCREEN --- */
        #menu-screen { align-items: center; justify-content: center; background: radial-gradient(circle, #1a1a2e, #000); }
        .logo-box { text-align: center; margin-bottom: 30px; }
        .logo-main { font-family: 'Teko', sans-serif; font-size: 70px; line-height: 0.8; background: linear-gradient(to right, #FFD700, #ff8c00); -webkit-background-clip: text; color: transparent; text-transform: uppercase; }
        .logo-sub { font-size: 18px; letter-spacing: 4px; color: #aaa; margin-top: 5px; }

        .btn { padding: 15px 30px; font-size: 18px; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; margin: 10px; width: 85%; max-width: 300px; text-transform: uppercase; transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); }
        .btn-host { background: linear-gradient(45deg, #00E676, #00C853); color: #003300; box-shadow: 0 0 15px rgba(0,230,118,0.3); }
        .btn-join { background: linear-gradient(45deg, #2979FF, #2962FF); color: white; box-shadow: 0 0 15px rgba(41,121,255,0.3); }

        .input-group { display: flex; flex-direction: column; gap: 10px; width: 85%; max-width: 300px; display: none; }
        .code-input { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #111; color: white; font-size: 16px; text-align: center; letter-spacing: 1px; }

        /* --- 2. LOBBY SCREEN --- */
        #lobby-screen { background: #111; padding: 20px; }
        .lobby-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .room-code { font-family: monospace; color: #FFD700; font-size: 20px; background: #222; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        
        .player-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 600px; margin: 0 auto; }
        .player-item { background: #222; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #555; }
        .player-item.host { border-left-color: #FFD700; }
        .player-item.me { background: #2a2a2a; }
        
        .char-select-overlay { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a; padding: 20px; border-top: 2px solid #333; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; align-items: center; }
        .char-select-overlay.show { transform: translateY(0); }
        .char-grid { display: flex; gap: 10px; overflow-x: auto; width: 100%; padding-bottom: 10px; justify-content: center; }
        .char-btn { width: 60px; height: 60px; border-radius: 10px; border: 2px solid #444; background: #222; font-size: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .char-btn.selected { border-color: #FFD700; background: #444; box-shadow: 0 0 10px rgba(255,215,0,0.3); }

        /* --- 3. GAME SCREEN --- */
        #game-screen { background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); }
        .bg-art { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .fort { position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); width: 80%; height: 200px; background: #f0f0f0; border: 2px solid #ccc; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: flex-end; }
        .pillar { width: 20px; height: 100%; background: linear-gradient(to right, #ddd, #fff, #ddd); margin: 0 15px; }
        .dome { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); width: 100px; height: 60px; background: #fff; border-radius: 50px 50px 0 0; border: 2px solid #ccc; border-bottom: none; }
        .flag { position: absolute; top: -100px; left: 50%; height: 40px; width: 2px; background: #333; }
        .flag-cloth { width: 30px; height: 20px; background: orange; position: absolute; top: 0; left: 0; }
        .floor { position: absolute; bottom: 0; width: 100%; height: 20%; background: #5D4037; border-top: 5px solid #3E2723; z-index: 1; }

        /* Spectator Badge */
        #spec-badge { position: absolute; top: 70px; width: 100%; text-align: center; background: rgba(0,0,0,0.7); color: #FFD700; padding: 5px; font-size: 14px; font-weight: bold; display: none; z-index: 90; }

        /* UPCOMING MATCHES LIST */
        #match-queue {
            position: absolute; top: 70px; right: 10px; 
            background: rgba(0,0,0,0.8); border: 1px solid #444; 
            padding: 10px; border-radius: 8px; z-index: 90;
            max-width: 150px; font-size: 12px; display: none;
        }
        .q-title { color: #aaa; border-bottom: 1px solid #555; margin-bottom: 5px; padding-bottom: 2px; font-weight: bold; }
        .q-item { color: white; margin-bottom: 2px; }
        .q-me { color: #FFD700; font-weight: bold; }

        /* HUD */
        .hud { position: absolute; top: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; z-index: 20; }
        .hp-container { width: 45%; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 8px; backdrop-filter: blur(5px); }
        .hp-name { display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: bold; margin-bottom: 5px; color: white; justify-content: space-between; }
        .hp-bar-bg { width: 100%; height: 12px; background: #333; border-radius: 10px; overflow: hidden; }
        .hp-fill { height: 100%; width: 100%; background: #00E676; transition: width 0.1s linear; }
        
        /* Fighters */
        .fighter { width: 80px; height: 140px; position: absolute; bottom: 20%; z-index: 10; transition: transform 0.1s; will-change: left, bottom; }
        .f-p1 { left: 20%; }
        .f-p2 { right: 20%; transform: scaleX(-1); }

        .head { width: 30px; height: 30px; background: #FFCCBC; border-radius: 50%; border: 2px solid #333; position: absolute; top: 0; left: 25px; z-index: 2; }
        .body { width: 34px; height: 50px; background: #333; border-radius: 5px; position: absolute; top: 28px; left: 23px; z-index: 1; }
        .sash { width: 34px; height: 50px; position: absolute; top: 28px; left: 23px; z-index: 2; opacity: 0.9; }
        .limb { width: 8px; height: 40px; background: #333; position: absolute; border-radius: 4px; }
        .arm-l { top: 30px; left: 18px; transform-origin: top; }
        .arm-r { top: 30px; right: 18px; transform-origin: top; }
        .leg-l { top: 75px; left: 25px; transform-origin: top; }
        .leg-r { top: 75px; right: 25px; transform-origin: top; }

        .punching .arm-r { transform: rotate(-90deg); background: #fff; }
        .kicking .leg-r { transform: rotate(-90deg); background: #fff; }
        .hit { filter: brightness(2) sepia(1) saturate(5) hue-rotate(-50deg); transform: translateX(-5px); }
        .ko { transform: rotate(90deg) translateY(50px); filter: grayscale(1); }

        /* Controls */
        #mobile-controls { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; flex-direction: column; justify-content: flex-end; padding: 20px; pointer-events: none; }
        .ctrl-row { display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px; pointer-events: auto; }
        .d-pad { display: flex; gap: 20px; }
        .action-pad { display: flex; gap: 20px; }

        .c-btn { width: 65px; height: 65px; border-radius: 50%; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.4); backdrop-filter: blur(4px); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .c-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }
        .btn-atk { background: rgba(255, 50, 50, 0.3); border-color: #ff5555; }
        .btn-jump { background: rgba(50, 255, 50, 0.3); border-color: #55ff55; }

        /* PC Hint */
        #pc-hint { position: absolute; top: 60px; width: 100%; text-align: center; font-size: 12px; color: rgba(0,0,0,0.5); z-index: 15; display: none; }

        /* Win Overlay */
        #win-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .win-title { font-family: 'Teko'; font-size: 70px; color: #FFD700; line-height: 1; }
        .win-sub { font-size: 24px; color: #fff; margin-bottom: 30px; font-family: 'Teko'; letter-spacing: 2px; }
        
        .leaderboard { width: 80%; background: #222; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .lb-row { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #444; color: #aaa; font-size: 14px; }
    </style>
</head>
<body>

    <!-- 1. MENU -->
    <div id="menu-screen" class="screen active">
        <div class="logo-box">
            <div class="logo-main">Assembly<br>Kombat</div>
            <div class="logo-sub">IPL TOURNAMENT</div>
        </div>
        
        <button class="btn btn-host" onclick="initHost()">Host Tournament</button>
        <button class="btn btn-join" onclick="showJoin()">Join Tournament</button>
        
        <div class="input-group" id="join-inputs">
            <input type="text" id="p-name" class="code-input" placeholder="YOUR NAME" maxlength="10">
            <input type="text" id="join-code" class="code-input" placeholder="ROOM CODE" maxlength="4">
            <button class="btn btn-join" id="join-action-btn" style="width:100%; margin:0;" onclick="joinGame()">Enter Arena</button>
        </div>
    </div>

    <!-- 2. LOBBY -->
    <div id="lobby-screen" class="screen">
        <div class="lobby-header">
            <div style="font-family:'Teko'; font-size:30px;">LOBBY</div>
            <div class="room-code" id="room-code-display" onclick="copyCode()">CODE: ....</div>
        </div>
        
        <div class="player-list" id="player-list"></div>

        <button id="start-btn" class="btn btn-host" style="width:100%; max-width:600px; margin: 20px auto; display:none;" onclick="startTournament()">START IPL MATCH</button>

        <div class="char-select-overlay" id="char-select">
            <div style="color:#aaa; margin-bottom:10px; font-size:12px;">CHOOSE YOUR LEADER</div>
            <div class="char-grid" id="char-grid"></div>
        </div>
    </div>

    <!-- 3. GAME -->
    <div id="game-screen" class="screen">
        <div class="bg-art">
            <div class="fort">
                <div class="dome"><div class="flag"><div class="flag-cloth"></div></div></div>
                <div class="pillar"></div><div class="pillar"></div><div class="pillar"></div><div class="pillar"></div>
            </div>
            <div class="floor"></div>
        </div>

        <div id="spec-badge">SPECTATING MATCH...</div>
        <div id="match-queue">
            <div class="q-title">UPCOMING</div>
            <div id="q-list"></div>
        </div>

        <div id="pc-hint">ARROWS: Move | SPACE: Jump | CTRL: Punch | SHIFT: Kick</div>

        <div class="hud">
            <div class="hp-container">
                <div class="hp-name"><span id="p1-name">P1</span> <span id="p1-char">ü¶Å</span></div>
                <div class="hp-bar-bg"><div id="hp-p1" class="hp-fill"></div></div>
            </div>
            <div class="hp-container" style="text-align:right; align-items: flex-end; display:flex; flex-direction:column;">
                <div class="hp-name"><span id="p2-name">P2</span> <span id="p2-char">üêØ</span></div>
                <div class="hp-bar-bg"><div id="hp-p2" class="hp-fill"></div></div>
            </div>
        </div>

        <div id="f-p1" class="fighter f-p1">
            <div class="head"></div><div id="sash-p1" class="sash"></div>
            <div class="body"></div><div class="arm-l limb"></div><div class="arm-r limb"></div><div class="leg-l limb"></div><div class="leg-r limb"></div>
        </div>
        <div id="f-p2" class="fighter f-p2">
            <div class="head"></div><div id="sash-p2" class="sash"></div>
            <div class="body"></div><div class="arm-l limb"></div><div class="arm-r limb"></div><div class="leg-l limb"></div><div class="leg-r limb"></div>
        </div>

        <div id="mobile-controls">
            <div class="ctrl-row">
                <div class="d-pad">
                    <div class="c-btn" ontouchstart="inputStart('left')" ontouchend="inputEnd('left')">‚Üê</div>
                    <div class="c-btn" ontouchstart="inputStart('right')" ontouchend="inputEnd('right')">‚Üí</div>
                </div>
                <div class="action-pad">
                    <div class="c-btn btn-jump" ontouchstart="inputStart('jump')">‚¨Ü</div>
                    <div class="c-btn btn-atk" ontouchstart="inputStart('punch')">üëä</div>
                    <div class="c-btn btn-atk" ontouchstart="inputStart('kick')">ü¶∂</div>
                </div>
            </div>
        </div>

        <div id="win-overlay">
            <div class="win-title" id="win-title">VIJAY WINS</div>
            <div class="win-sub">CM FOR 2026</div>
            
            <div class="leaderboard">
                <div class="lb-row" style="color:#FFD700; font-weight:bold;"><span>PLAYER</span><span>WINS</span></div>
                <div id="lb-content"></div>
            </div>

            <button class="btn btn-host" id="next-match-btn" style="display:none;" onclick="nextMatch()">NEXT MATCH</button>
            <div id="wait-msg" style="color:#aaa; font-size:14px; margin-top:10px; display:none;">Waiting for Host...</div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const CHARS = [
            { id: 'vijay', name: 'VIJAY', color: 'gold', icon: 'ü¶Å' },
            { id: 'stalin', name: 'STALIN', color: '#ff3333', icon: '‚òÄÔ∏è' },
            { id: 'eps', name: 'EPS', color: '#00cc00', icon: 'üçÉ' },
            { id: 'anna', name: 'ANNA', color: '#ff9900', icon: 'ü™∑' },
            { id: 'seeman', name: 'SEEMAN', color: '#333', icon: 'üêØ' }
        ];

        // PHYSICS TUNING
        const GRAVITY = 0.6;
        const JUMP_FORCE = 12; 
        const MOVE_SPEED = 0.6; 
        const GROUND_Y = 20;

        // PEER CONFIG FOR RELIABILITY
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' },
                    // Public STUN to help mobile/pc connectivity
                    { urls: 'stun:stun.services.mozilla.com' }
                ]
            }
        };

        // --- STATE ---
        let myId = null;
        let myName = "Player";
        let myChar = CHARS[0];
        let role = 'guest'; 
        let peer = null;
        
        // Host Data
        let connections = []; 
        let players = []; 
        let currentMatch = { p1: null, p2: null }; 
        let tournamentStarted = false; // LOCK
        
        // Game State
        let gameState = {
            p1: { x: 20, y: 0, vy: 0, hp: 100, action: null, id: null },
            p2: { x: 80, y: 0, vy: 0, hp: 100, action: null, id: null },
            active: false,
            winner: null
        };
        
        let inputs = { left: false, right: false };

        function isMobile() { return /Android|iPhone|iPad/i.test(navigator.userAgent); }

        // --- UI ---
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showJoin() { document.getElementById('join-inputs').style.display = 'flex'; }

        function renderCharGrid() {
            const g = document.getElementById('char-grid');
            g.innerHTML = '';
            CHARS.forEach(c => {
                const b = document.createElement('div');
                b.className = 'char-btn';
                b.innerText = c.icon;
                b.onclick = () => selectChar(c);
                if(c.id === myChar.id) b.classList.add('selected');
                g.appendChild(b);
            });
        }
        renderCharGrid();

        function selectChar(c) {
            myChar = c;
            renderCharGrid();
            if(role === 'guest' && peer) sendToHost({ type: 'update_profile', name: myName, char: c });
            if(role === 'host') updateMyProfileHost();
        }

        // --- HOST LOGIC ---
        function generateId() { return Math.random().toString(36).substring(2,6).toUpperCase(); }

        function initHost() {
            role = 'host';
            myId = generateId(); 
            myName = "HOST";
            
            players.push({ id: 'HOST', name: myName, char: myChar, wins: 0, conn: null });

            if(peer) peer.destroy();
            peer = new Peer(myId, peerConfig);
            
            peer.on('open', (id) => {
                switchScreen('lobby-screen');
                document.getElementById('room-code-display').innerText = `CODE: ${id}`;
                document.getElementById('char-select').classList.add('show');
                renderPlayerList();
                document.getElementById('start-btn').style.display = 'block';
            });

            peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    if(data.type === 'join') {
                        if(tournamentStarted) {
                            conn.send({ type: 'reject', msg: 'Match in Progress! Locked.' });
                            return;
                        }
                        connections.push(conn); // Only add if not started
                        players.push({ id: conn.peer, name: data.name, char: data.char, wins: 0, conn: conn });
                        broadcastLobby();
                    }
                    if(data.type === 'update_profile') {
                        const p = players.find(x => x.id === conn.peer);
                        if(p) { p.name = data.name; p.char = data.char; }
                        broadcastLobby();
                    }
                    if(data.type === 'input') {
                        handleInput(conn.peer, data);
                    }
                });
            });
        }

        function updateMyProfileHost() {
            players[0].char = myChar;
            broadcastLobby();
        }

        function broadcastLobby() {
            renderPlayerList();
            const cleanList = players.map(p => ({ id: p.id, name: p.name, char: p.char, wins: p.wins }));
            connections.forEach(c => c.send({ type: 'lobby_update', players: cleanList }));
        }

        function renderPlayerList() {
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            players.forEach(p => {
                const div = document.createElement('div');
                div.className = `player-item ${p.id === 'HOST' ? 'host' : ''}`;
                div.innerHTML = `<div><span style="font-size:20px">${p.char.icon}</span> <b>${p.name}</b></div> <div>Wins: ${p.wins}</div>`;
                list.appendChild(div);
            });
        }

        function startTournament() {
            if(players.length < 2) return alert("Need at least 2 players!");
            
            tournamentStarted = true; // LOCK LOBBY
            
            // Initial Match: P1 vs P2
            currentMatch.p1 = players[0].id;
            currentMatch.p2 = players[1].id;
            
            startMatch();
        }

        function startMatch() {
            gameState.p1 = { x: 20, y: 0, vy: 0, hp: 100, action: null, id: currentMatch.p1 };
            gameState.p2 = { x: 80, y: 0, vy: 0, hp: 100, action: null, id: currentMatch.p2 };
            gameState.active = true;
            gameState.winner = null;

            const p1Obj = players.find(p => p.id === currentMatch.p1);
            const p2Obj = players.find(p => p.id === currentMatch.p2);
            
            // Queue: Everyone after the first 2
            const queueNames = players.slice(2).map(p => p.name);

            const matchData = { 
                p1: { name: p1Obj.name, char: p1Obj.char, id: p1Obj.id },
                p2: { name: p2Obj.name, char: p2Obj.char, id: p2Obj.id },
                queue: queueNames
            };

            const payload = { type: 'match_start', match: matchData };
            connections.forEach(c => c.send(payload));
            
            setupGameUI(matchData);
            requestAnimationFrame(gameLoop);
        }

        function nextMatch() {
            const winnerId = gameState.winner;
            const loserId = (currentMatch.p1 === winnerId) ? currentMatch.p2 : currentMatch.p1;
            
            // Loser to end
            const loserIndex = players.findIndex(p => p.id === loserId);
            const loserObj = players.splice(loserIndex, 1)[0];
            players.push(loserObj);
            
            // Winner to front
            const winnerIndex = players.findIndex(p => p.id === winnerId);
            const winnerObj = players.splice(winnerIndex, 1)[0];
            players.unshift(winnerObj);
            
            broadcastLobby(); 

            currentMatch.p1 = players[0].id;
            currentMatch.p2 = players[1].id;
            
            document.getElementById('win-overlay').style.display = 'none';
            startMatch();
        }

        // --- GUEST LOGIC ---
        function joinGame() {
            role = 'guest';
            myName = document.getElementById('p-name').value || "Guest";
            const code = document.getElementById('join-code').value.toUpperCase();
            if(!code) return alert("Enter Code");

            // Feedback UI
            const btn = document.getElementById('join-action-btn');
            btn.innerText = "CONNECTING...";
            btn.disabled = true;

            // Cleanup prev
            if(peer) peer.destroy();

            // INSTANT PEER ID GENERATION (Key Fix)
            const myGuestId = "G-" + generateId();
            peer = new Peer(myGuestId, peerConfig);

            // Timeout Handler
            const connTimeout = setTimeout(() => {
                if(btn.disabled) {
                    alert("Connection Timed Out. Try again.");
                    btn.innerText = "ENTER ARENA";
                    btn.disabled = false;
                    if(peer) peer.destroy();
                }
            }, 10000);

            peer.on('open', (id) => {
                myId = id;
                const conn = peer.connect(code, { reliable: true });
                
                conn.on('open', () => {
                    clearTimeout(connTimeout);
                    peer.conn = conn; 
                    conn.send({ type: 'join', name: myName, char: myChar });
                });
                
                conn.on('data', (data) => {
                    if(data.type === 'reject') {
                        alert(data.msg);
                        location.reload();
                    }
                    if(data.type === 'lobby_update') {
                        switchScreen('lobby-screen'); 
                        document.getElementById('room-code-display').innerText = `CONNECTED: ${code}`;
                        document.getElementById('char-select').classList.add('show');
                        players = data.players;
                        renderPlayerList();
                    }
                    if(data.type === 'match_start') {
                        setupGameUI(data.match);
                    }
                    if(data.type === 'sync') {
                        renderGame(data.state);
                    }
                });

                conn.on('error', (err) => {
                    clearTimeout(connTimeout);
                    alert("Connection Failed. Check Code.");
                    btn.innerText = "ENTER ARENA";
                    btn.disabled = false;
                });
            });

            peer.on('error', (err) => {
                clearTimeout(connTimeout);
                alert("Network Error: " + err.type);
                btn.innerText = "ENTER ARENA";
                btn.disabled = false;
            });
        }
        
        function sendToHost(msg) {
            if(peer && peer.conn) peer.conn.send(msg);
        }

        // --- GAMEPLAY UI ---
        function setupGameUI(match) {
            switchScreen('game-screen');
            document.getElementById('win-overlay').style.display = 'none';

            document.getElementById('p1-name').innerText = match.p1.name;
            document.getElementById('p1-char').innerText = match.p1.char.icon;
            document.getElementById('sash-p1').style.background = match.p1.char.color;
            
            document.getElementById('p2-name').innerText = match.p2.name;
            document.getElementById('p2-char').innerText = match.p2.char.icon;
            document.getElementById('sash-p2').style.background = match.p2.char.color;
            
            // Setup Queue List
            const qList = document.getElementById('q-list');
            qList.innerHTML = '';
            if(match.queue && match.queue.length > 0) {
                document.getElementById('match-queue').style.display = 'block';
                match.queue.forEach((name, i) => {
                    const div = document.createElement('div');
                    div.className = 'q-item';
                    if(name === myName) div.classList.add('q-me');
                    div.innerText = `${i+1}. ${name}`;
                    qList.appendChild(div);
                });
            } else {
                document.getElementById('match-queue').style.display = 'none';
            }

            let amIPlaying = false;
            
            if(role === 'host') {
                if(match.p1.id === 'HOST' || match.p2.id === 'HOST') amIPlaying = true;
            } else {
                if(match.p1.id === myId || match.p2.id === myId) amIPlaying = true;
            }

            if(amIPlaying) {
                document.getElementById('spec-badge').style.display = 'none';
                if(isMobile()) document.getElementById('mobile-controls').style.display = 'flex';
                else {
                    document.getElementById('pc-hint').style.display = 'block';
                    setupPCControls();
                }
            } else {
                // Spectator
                document.getElementById('spec-badge').style.display = 'block';
                document.getElementById('mobile-controls').style.display = 'none';
                document.getElementById('pc-hint').style.display = 'none';
                window.onkeydown = null; 
            }
        }

        // --- GAME ENGINE ---
        function handleInput(playerId, data) {
            let pKey = null;
            if(playerId === gameState.p1.id) pKey = 'p1';
            if(playerId === gameState.p2.id) pKey = 'p2';
            
            if(!pKey) return; 

            if(data.type === 'move') {
                if(!gameState.inputs) gameState.inputs = { p1: 0, p2: 0 };
                gameState.inputs[pKey] = data.dir;
            }
            if(data.type === 'jump') doJump(pKey);
            if(data.type === 'punch' || data.type === 'kick') doAttack(pKey, data.type);
        }

        function hostInput(data) { handleInput('HOST', data); }

        function gameLoop() {
            if(!gameState.active) return;

            if(!gameState.inputs) gameState.inputs = { p1: 0, p2: 0 };

            ['p1', 'p2'].forEach(key => {
                const p = gameState[key];
                const dir = gameState.inputs[key];

                p.vy -= GRAVITY;
                p.y += p.vy;
                if(p.y < 0) { p.y = 0; p.vy = 0; }
                if(dir !== 0 && !p.action) {
                    p.x = Math.max(0, Math.min(90, p.x + (dir * MOVE_SPEED)));
                }
            });

            const syncData = { type: 'sync', state: gameState };
            connections.forEach(c => c.send(syncData));
            renderGame(gameState);

            requestAnimationFrame(gameLoop);
        }

        function doJump(key) {
            const p = gameState[key];
            if(p.y <= 0.1) p.vy = JUMP_FORCE; 
        }

        function doAttack(key, type) {
            const actor = gameState[key];
            if(actor.action) return;
            actor.action = type;
            setTimeout(() => actor.action = null, 300);

            const enemyKey = key === 'p1' ? 'p2' : 'p1';
            const enemy = gameState[enemyKey];
            const dx = Math.abs(actor.x - enemy.x);
            const dy = Math.abs(actor.y - enemy.y);

            if(dx < 15 && dy < 15) {
                const dmg = type === 'punch' ? 5 : 10;
                enemy.hp = Math.max(0, enemy.hp - dmg);
                if(enemy.hp <= 0) endGame(key);
            }
        }

        function endGame(winnerKey) {
            gameState.active = false;
            
            const wId = gameState[winnerKey].id;
            const winnerObj = players.find(p => p.id === wId);
            winnerObj.wins++;
            gameState.winner = wId;

            const syncData = { type: 'sync', state: gameState };
            connections.forEach(c => c.send(syncData));
            renderGame(gameState);
        }

        // --- RENDERER ---
        function renderGame(state) {
            document.getElementById('hp-p1').style.width = state.p1.hp + '%';
            document.getElementById('hp-p2').style.width = state.p2.hp + '%';
            
            const e1 = document.getElementById('f-p1');
            const e2 = document.getElementById('f-p2');
            
            e1.style.left = state.p1.x + '%';
            e1.style.bottom = (20 + state.p1.y/2) + '%';
            e2.style.left = state.p2.x + '%';
            e2.style.bottom = (20 + state.p2.y/2) + '%';
            
            setAnim(e1, state.p1.action);
            setAnim(e2, state.p2.action);
            
            if(!state.active && state.winner) {
                document.getElementById('win-overlay').style.display = 'flex';
                const wObj = players.find(p => p.id === state.winner);
                document.getElementById('win-title').innerText = wObj ? wObj.name : "WINNER";
                
                // Show Leaderboard
                const lb = document.getElementById('lb-content');
                lb.innerHTML = '';
                const sorted = [...players].sort((a,b) => b.wins - a.wins);
                sorted.forEach(p => {
                    const r = document.createElement('div');
                    r.className = 'lb-row';
                    r.innerHTML = `<span>${p.name}</span> <span>${p.wins}</span>`;
                    lb.appendChild(r);
                });

                if(role === 'host') {
                    document.getElementById('next-match-btn').style.display = 'block';
                    document.getElementById('wait-msg').style.display = 'none';
                } else {
                    document.getElementById('next-match-btn').style.display = 'none';
                    document.getElementById('wait-msg').style.display = 'block';
                }
            }
        }

        function setAnim(el, act) {
            el.classList.remove('punching', 'kicking');
            if(act === 'punch') el.classList.add('punching');
            if(act === 'kick') el.classList.add('kicking');
        }

        // --- CONTROLS ---
        function setupPCControls() {
            window.onkeydown = (e) => {
                if(e.repeat) return;
                const code = e.key;
                let data = null;
                if(code === 'ArrowLeft') data = { type: 'move', dir: -1 };
                if(code === 'ArrowRight') data = { type: 'move', dir: 1 };
                if(code === ' ') data = { type: 'jump' };
                if(code === 'Control') data = { type: 'punch' };
                if(code === 'Shift') data = { type: 'kick' };

                if(data) sendInput(data);
            };
            window.onkeyup = (e) => {
                if(e.key === 'ArrowLeft' || e.key === 'ArrowRight') sendInput({ type: 'move', dir: 0 });
            };
        }

        function inputStart(act) {
            if(act==='left') sendInput({ type:'move', dir: -1 });
            else if(act==='right') sendInput({ type:'move', dir: 1 });
            else sendInput({ type: act });
        }
        function inputEnd(act) {
            if(act==='left'||act==='right') sendInput({ type:'move', dir: 0 });
        }

        function sendInput(data) {
            if(role === 'host') hostInput(data);
            else sendToHost({ type: 'input', ...data });
        }
        
        function copyCode() {
            navigator.clipboard.writeText(myId);
            alert("Code Copied!");
        }
    </script>
</body>
</html>
