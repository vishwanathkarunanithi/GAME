<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Assembly Kombat: Ultimate</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@600&family=Roboto:wght@700&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body { margin: 0; background: #111; font-family: 'Roboto', sans-serif; overflow: hidden; color: white; }

        /* --- SCREENS --- */
        .screen { display: none; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; flex-direction: column; }
        .active { display: flex; }

        /* --- 1. MENU SCREEN --- */
        #menu-screen { align-items: center; justify-content: center; background: radial-gradient(circle, #2a2a2a, #000); }
        .logo-box { text-align: center; margin-bottom: 40px; }
        .logo-main { font-family: 'Teko', sans-serif; font-size: 80px; line-height: 0.8; background: linear-gradient(to right, #FFD700, #ff8c00); -webkit-background-clip: text; color: transparent; text-transform: uppercase; }
        .logo-sub { font-size: 20px; letter-spacing: 5px; color: #888; margin-top: 10px; }

        .btn { padding: 15px 40px; font-size: 20px; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; margin: 10px; width: 80%; max-width: 300px; transition: transform 0.1s; text-transform: uppercase; }
        .btn:active { transform: scale(0.95); }
        .btn-host { background: linear-gradient(45deg, #00E676, #00C853); color: #003300; box-shadow: 0 5px 15px rgba(0,230,118,0.4); }
        .btn-join { background: linear-gradient(45deg, #2979FF, #2962FF); color: white; box-shadow: 0 5px 15px rgba(41,121,255,0.4); }

        .join-box { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; margin-top: 20px; display: none; flex-direction: column; gap: 10px; }
        .code-input { padding: 15px; border-radius: 10px; border: 2px solid #555; background: #000; color: white; font-size: 20px; text-align: center; text-transform: uppercase; letter-spacing: 2px; }

        /* --- 2. LOBBY SCREEN (Character Select) --- */
        #lobby-screen { background: #1a1a1a; padding: 20px; }
        .lobby-header { text-align: center; font-family: 'Teko'; font-size: 40px; margin-bottom: 20px; color: #aaa; }
        .char-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 15px; width: 100%; max-width: 600px; margin: 0 auto; }
        
        .char-card { background: #333; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; position: relative; opacity: 0.7; }
        .char-card:hover { opacity: 1; background: #444; }
        
        /* SELECTED STATE: Glows Gold */
        .char-card.selected { border-color: #FFD700; background: #444; transform: translateY(-5px); opacity: 1; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        
        .char-icon { font-size: 40px; display: block; margin-bottom: 5px; }
        .char-name { font-size: 12px; font-weight: bold; color: #ddd; }
        
        .p-badge { position: absolute; top: -10px; right: -10px; background: red; font-size: 10px; padding: 3px 6px; border-radius: 4px; display: none; font-weight: bold; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .p1-badge { display: block; background: #00E676; color: black; }
        .p2-badge { display: block; background: #2979FF; color: white; }

        .lobby-status { margin-top: auto; text-align: center; padding: 20px; font-size: 18px; color: #888; }
        .room-code-pill { background: #333; padding: 5px 15px; border-radius: 20px; font-family: monospace; color: #FFD700; display: inline-block; margin-top: 10px; cursor: pointer; }

        /* --- 3. GAME SCREEN --- */
        #game-screen { position: relative; overflow: hidden; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); }

        /* Decent Background: TN Assembly Vector Art */
        .bg-art { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .fort { 
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); 
            width: 80%; height: 200px; background: #f0f0f0; 
            border: 2px solid #ccc; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: flex-end;
        }
        .pillar { width: 20px; height: 100%; background: linear-gradient(to right, #ddd, #fff, #ddd); margin: 0 15px; }
        .dome { 
            position: absolute; top: -60px; left: 50%; transform: translateX(-50%); 
            width: 100px; height: 60px; background: #fff; 
            border-radius: 50px 50px 0 0; border: 2px solid #ccc; border-bottom: none;
        }
        .flag { position: absolute; top: -100px; left: 50%; height: 40px; width: 2px; background: #333; }
        .flag-cloth { width: 30px; height: 20px; background: orange; position: absolute; top: 0; left: 0; }
        .floor { position: absolute; bottom: 0; width: 100%; height: 20%; background: #5D4037; border-top: 5px solid #3E2723; z-index: 1; }

        /* HUD */
        .hud { position: absolute; top: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; z-index: 20; }
        .hp-container { width: 45%; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 8px; backdrop-filter: blur(5px); }
        .hp-name { display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: bold; margin-bottom: 5px; color: white; }
        .hp-bar-bg { width: 100%; height: 15px; background: #333; border-radius: 10px; overflow: hidden; }
        .hp-fill { height: 100%; width: 100%; background: #00E676; transition: width 0.1s linear; }
        
        /* Fighters */
        .fighter { width: 80px; height: 140px; position: absolute; bottom: 20%; z-index: 10; transition: transform 0.1s; will-change: left; }
        .f-p1 { left: 20%; }
        .f-p2 { right: 20%; transform: scaleX(-1); }

        /* Minimal Stickman */
        .head { width: 30px; height: 30px; background: #FFCCBC; border-radius: 50%; border: 2px solid #333; position: absolute; top: 0; left: 25px; z-index: 2; }
        .body { width: 34px; height: 50px; background: #333; border-radius: 5px; position: absolute; top: 28px; left: 23px; z-index: 1; }
        .sash { width: 34px; height: 50px; position: absolute; top: 28px; left: 23px; z-index: 2; opacity: 0.9; }
        .limb { width: 8px; height: 40px; background: #333; position: absolute; border-radius: 4px; }
        .arm-l { top: 30px; left: 18px; transform-origin: top; }
        .arm-r { top: 30px; right: 18px; transform-origin: top; }
        .leg-l { top: 75px; left: 25px; transform-origin: top; }
        .leg-r { top: 75px; right: 25px; transform-origin: top; }

        /* Animations */
        .punching .arm-r { transform: rotate(-90deg); background: #fff; }
        .kicking .leg-r { transform: rotate(-90deg); background: #fff; }
        .hit { filter: brightness(2) sepia(1) saturate(5) hue-rotate(-50deg); transform: translateX(-5px); }
        .ko { transform: rotate(90deg) translateY(50px); filter: grayscale(1); }

        /* --- MOBILE CONTROLS (Overlaid on Game) --- */
        #mobile-controls {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; display: flex; flex-direction: column; justify-content: flex-end;
            padding: 20px; pointer-events: none; /* Let touches pass to buttons */
        }
        
        .ctrl-row { display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px; pointer-events: auto; }
        
        .d-pad { display: flex; gap: 20px; }
        .action-pad { display: flex; gap: 20px; }

        .c-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(5px); color: white; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .c-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
        .btn-atk { background: rgba(255, 50, 50, 0.4); border-color: #ff5555; }
        
        /* Win Overlay */
        #win-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .win-title { font-family: 'Teko'; font-size: 80px; color: #FFD700; line-height: 1; }
        .win-sub { font-size: 20px; color: #fff; margin-bottom: 30px; }
    </style>
</head>
<body>

    <!-- 1. MAIN MENU -->
    <div id="menu-screen" class="screen active">
        <div class="logo-box">
            <div class="logo-main">Assembly<br>Kombat</div>
            <div class="logo-sub">ULTIMATE</div>
        </div>
        
        <button class="btn btn-host" onclick="initHost()">Host Game</button>
        <button class="btn btn-join" onclick="document.querySelector('.join-box').style.display = 'flex'">Join Game</button>
        
        <div class="join-box">
            <input type="text" id="join-code" class="code-input" placeholder="Enter Code" maxlength="4">
            <button class="btn btn-join" style="width:100%; margin:0;" onclick="joinGame()">Connect</button>
        </div>
    </div>

    <!-- 2. LOBBY SCREEN -->
    <div id="lobby-screen" class="screen">
        <div class="lobby-header">SELECT LEADER</div>
        
        <div class="char-grid" id="char-grid">
            <!-- Generated by JS -->
        </div>

        <div class="lobby-status">
            <div id="lobby-msg">Waiting for opponent...</div>
            <div class="room-code-pill" id="room-code-display" onclick="copyCode()">CODE: ....</div>
        </div>
        
        <button id="start-btn" class="btn btn-host" style="width:100%; max-width:100%; display:none;" onclick="requestStart()">START MATCH</button>
    </div>

    <!-- 3. GAME SCREEN -->
    <div id="game-screen" class="screen">
        <!-- Background Art -->
        <div class="bg-art">
            <div class="fort">
                <div class="dome"><div class="flag"><div class="flag-cloth"></div></div></div>
                <div class="pillar"></div><div class="pillar"></div><div class="pillar"></div><div class="pillar"></div>
            </div>
            <div class="floor"></div>
        </div>

        <!-- HUD -->
        <div class="hud">
            <div class="hp-container">
                <div class="hp-name"><span id="p1-icon">ü¶Å</span> <span id="p1-name">VIJAY</span></div>
                <div class="hp-bar-bg"><div id="hp-p1" class="hp-fill"></div></div>
            </div>
            <div class="hp-container" style="text-align:right; align-items: flex-end; display:flex; flex-direction:column;">
                <div class="hp-name"><span id="p2-name">OPPONENT</span> <span id="p2-icon">üêØ</span></div>
                <div class="hp-bar-bg"><div id="hp-p2" class="hp-fill"></div></div>
            </div>
        </div>

        <!-- Fighters -->
        <div id="f-p1" class="fighter f-p1">
            <div class="head"></div><div id="sash-p1" class="sash"></div>
            <div class="body"></div><div class="arm-l limb"></div><div class="arm-r limb"></div><div class="leg-l limb"></div><div class="leg-r limb"></div>
        </div>
        <div id="f-p2" class="fighter f-p2">
            <div class="head"></div><div id="sash-p2" class="sash"></div>
            <div class="body"></div><div class="arm-l limb"></div><div class="arm-r limb"></div><div class="leg-l limb"></div><div class="leg-r limb"></div>
        </div>

        <!-- Controls -->
        <div id="mobile-controls">
            <div class="ctrl-row">
                <div class="d-pad">
                    <div class="c-btn" ontouchstart="inputStart('left')" ontouchend="inputEnd('left')">‚Üê</div>
                    <div class="c-btn" ontouchstart="inputStart('right')" ontouchend="inputEnd('right')">‚Üí</div>
                </div>
                <div class="action-pad">
                    <div class="c-btn btn-atk" ontouchstart="inputStart('punch')">üëä</div>
                    <div class="c-btn btn-atk" ontouchstart="inputStart('kick')">ü¶∂</div>
                </div>
            </div>
        </div>

        <!-- Win Overlay -->
        <div id="win-overlay">
            <div class="win-title" id="win-title">VIJAY WINS</div>
            <div class="win-sub">IS THE NEW CM!</div>
            <button class="btn btn-host" onclick="requestRematch()">BACK TO LOBBY</button>
        </div>
    </div>

    <script>
        // --- GAME DATA ---
        const CHARS = [
            { id: 'vijay', name: 'VIJAY', color: 'gold', icon: 'ü¶Å' },
            { id: 'stalin', name: 'STALIN', color: '#ff3333', icon: '‚òÄÔ∏è' },
            { id: 'eps', name: 'EPS', color: '#00cc00', icon: 'üçÉ' },
            { id: 'anna', name: 'ANNAMALAI', color: '#ff9900', icon: 'ü™∑' },
            { id: 'seeman', name: 'SEEMAN', color: '#333', icon: 'üêØ' }
        ];

        // --- STATE ---
        let role = null; // 'host' or 'guest'
        let peer = null, conn = null;
        let myChar = null, oppChar = null;
        let gameState = {
            p1: { x: 20, hp: 100, action: null },
            p2: { x: 80, hp: 100, action: null },
            active: false
        };
        let inputs = { left: false, right: false }; // My inputs

        // --- 1. SETUP & LOBBY ---
        
        function renderLobby() {
            const grid = document.getElementById('char-grid');
            grid.innerHTML = '';
            CHARS.forEach(c => {
                const el = document.createElement('div');
                el.className = 'char-card';
                el.id = `char-${c.id}`;
                el.innerHTML = `<span class="char-icon">${c.icon}</span><div class="char-name">${c.name}</div>
                                <div id="badge-${c.id}-p1" class="p-badge p1-badge">P1</div>
                                <div id="badge-${c.id}-p2" class="p-badge p2-badge">P2</div>`;
                el.onclick = () => selectChar(c.id);
                grid.appendChild(el);
            });
        }
        renderLobby();

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- PEER JS LOGIC ---
        function generateId() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let r = ""; for(let i=0;i<4;i++) r += chars[Math.floor(Math.random()*chars.length)];
            return r;
        }

        function initHost() {
            role = 'host';
            const code = generateId();
            peer = new Peer(code);
            peer.on('open', (id) => {
                switchScreen('lobby-screen');
                document.getElementById('room-code-display').innerText = `CODE: ${id}`;
                document.getElementById('lobby-msg').innerText = "Share Code. Waiting for Player 2...";
            });
            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
                document.getElementById('lobby-msg').innerText = "PLAYER 2 CONNECTED! SELECT LEADER.";
            });
        }

        function joinGame() {
            role = 'guest';
            const code = document.getElementById('join-code').value.toUpperCase();
            if(code.length !== 4) return alert("Invalid Code");
            
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(code);
                conn.on('open', () => {
                    setupConnection();
                    switchScreen('lobby-screen');
                    document.getElementById('room-code-display').innerText = `CONNECTED TO: ${code}`;
                    document.getElementById('lobby-msg').innerText = "CONNECTED! SELECT LEADER.";
                });
            });
        }

        function setupConnection() {
            conn.on('data', (data) => {
                // HANDLE INCOMING MESSAGES
                if(data.type === 'select') {
                    // Update Opponent Selection
                    oppChar = CHARS.find(c => c.id === data.id);
                    updateBadges(data.id, role === 'host' ? 'p2' : 'p1');
                    checkStart();
                }
                if(data.type === 'start') {
                    startGame();
                }
                if(data.type === 'rematch') {
                    resetLobby();
                }
                if(data.type === 'input') {
                    // Host receives Input from Guest
                    if(role === 'host') handleGuestInput(data);
                }
                if(data.type === 'sync') {
                    // Guest receives State from Host
                    if(role === 'guest') renderGame(data.state);
                }
            });
        }

        // --- LOBBY ACTIONS ---
        function selectChar(id) {
            myChar = CHARS.find(c => c.id === id);
            
            // Visual Highlight (Gold Border)
            document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`char-${id}`).classList.add('selected');
            
            // Show Badge
            updateBadges(id, role === 'host' ? 'p1' : 'p2');
            
            // Send to peer
            if(conn) conn.send({ type: 'select', id: id });
            checkStart();
        }

        function updateBadges(charId, playerRole) {
            // Hide all badges for this role first
            const badgeClass = playerRole === 'p1' ? '.p1-badge' : '.p2-badge';
            document.querySelectorAll(badgeClass).forEach(e => e.style.display = 'none');
            // Show specific badge
            const badgeId = `badge-${charId}-${playerRole}`;
            const badge = document.getElementById(badgeId);
            if(badge) badge.style.display = 'block';
        }

        function checkStart() {
            if(myChar && oppChar && role === 'host') {
                document.getElementById('start-btn').style.display = 'block';
            }
        }

        function requestStart() {
            conn.send({ type: 'start' });
            startGame();
        }

        function requestRematch() {
            if(conn) conn.send({ type: 'rematch' });
            resetLobby();
        }

        function resetLobby() {
            gameState.active = false;
            document.getElementById('win-overlay').style.display = 'none';
            switchScreen('lobby-screen');
        }

        // --- GAME ENGINE ---
        function startGame() {
            // Reset Game State
            gameState.p1.hp = 100; gameState.p1.x = 20;
            gameState.p2.hp = 100; gameState.p2.x = 80;
            
            switchScreen('game-screen');
            
            // Setup Visuals
            const p1 = role === 'host' ? myChar : oppChar;
            const p2 = role === 'host' ? oppChar : myChar;
            
            document.getElementById('p1-name').innerText = p1.name;
            document.getElementById('p1-icon').innerText = p1.icon;
            document.getElementById('sash-p1').style.background = p1.color;
            
            document.getElementById('p2-name').innerText = p2.name;
            document.getElementById('p2-icon').innerText = p2.icon;
            document.getElementById('sash-p2').style.background = p2.color;

            if(role === 'host') {
                gameState.active = true;
                requestAnimationFrame(gameLoop);
            }
        }

        // INPUT HANDLERS
        function inputStart(action) {
            if(action === 'punch' || action === 'kick') {
                sendInput({ type: action });
            } else {
                inputs[action] = true;
                updateMoveInput();
            }
        }
        function inputEnd(action) {
            inputs[action] = false;
            updateMoveInput();
        }
        
        function updateMoveInput() {
            let dir = 0;
            if(inputs.left) dir = -1;
            if(inputs.right) dir = 1;
            sendInput({ type: 'move', dir: dir });
        }

        function sendInput(data) {
            if(role === 'guest') {
                conn.send({ type: 'input', ...data });
            } else {
                handleHostInput(data);
            }
        }

        // --- HOST LOGIC LOOP ---
        let p1Input = { dir: 0 }, p2Input = { dir: 0 };

        function handleHostInput(data) {
            if(data.type === 'move') p1Input.dir = data.dir;
            if(data.type === 'punch' || data.type === 'kick') doAttack('p1', data.type);
        }
        function handleGuestInput(data) {
            if(data.type === 'move') p2Input.dir = data.dir;
            if(data.type === 'punch' || data.type === 'kick') doAttack('p2', data.type);
        }

        function doAttack(player, type) {
            if(!gameState.active) return;
            const actor = gameState[player];
            if(actor.action) return; // Cooldown

            // 1. Set Action
            actor.action = type;
            setTimeout(() => actor.action = null, 400); // Reset after anim

            // 2. Check Hit
            const p1 = gameState.p1;
            const p2 = gameState.p2;
            const dist = Math.abs(p1.x - p2.x);
            
            if(dist < 15) { // Hit range
                const victimKey = player === 'p1' ? 'p2' : 'p1';
                const dmg = type === 'punch' ? 5 : 10;
                
                gameState[victimKey].hp = Math.max(0, gameState[victimKey].hp - dmg);
                
                if(gameState[victimKey].hp <= 0) endGame(player);
            }
        }

        function endGame(winnerKey) {
            gameState.active = false;
            const winner = winnerKey === 'p1' ? (role === 'host' ? myChar : oppChar) : (role === 'host' ? oppChar : myChar);
            
            // Send final state
            conn.send({ type: 'sync', state: gameState });
            
            renderGame(gameState); // Render final frame
            showWin(winner.name);
        }

        function showWin(name) {
            document.getElementById('win-overlay').style.display = 'flex';
            document.getElementById('win-title').innerText = name + " WINS";
        }

        function gameLoop() {
            if(!gameState.active) return;

            // Update Positions
            if(p1Input.dir !== 0 && !gameState.p1.action) gameState.p1.x = Math.max(0, Math.min(90, gameState.p1.x + (p1Input.dir * 0.8)));
            if(p2Input.dir !== 0 && !gameState.p2.action) gameState.p2.x = Math.max(0, Math.min(90, gameState.p2.x + (p2Input.dir * 0.8)));

            // Sync to Guest
            conn.send({ type: 'sync', state: gameState });
            
            // Render Host
            renderGame(gameState);

            requestAnimationFrame(gameLoop);
        }

        // --- RENDERER (Runs on both) ---
        function renderGame(state) {
            // Update Bars
            document.getElementById('hp-p1').style.width = state.p1.hp + '%';
            document.getElementById('hp-p2').style.width = state.p2.hp + '%';

            // Update Positions
            const elP1 = document.getElementById('f-p1');
            const elP2 = document.getElementById('f-p2');
            
            elP1.style.left = state.p1.x + '%';
            elP2.style.left = state.p2.x + '%'; // Note: P2 is right-aligned visually, but X is absolute %

            // Update Animations
            updateAnim(elP1, state.p1.action);
            updateAnim(elP2, state.p2.action);
            
            // KO Logic
            if(state.p1.hp <= 0) elP1.classList.add('ko');
            if(state.p2.hp <= 0) elP2.classList.add('ko');
            if(!state.active && (state.p1.hp <= 0 || state.p2.hp <= 0)) {
                // Infer winner from state if sync msg missed
                let w = state.p1.hp > 0 ? (role==='host'?myChar.name:oppChar.name) : (role==='host'?oppChar.name:myChar.name);
                showWin(w);
            }
        }

        function updateAnim(el, action) {
            el.classList.remove('punching', 'kicking');
            if(action === 'punch') el.classList.add('punching');
            if(action === 'kick') el.classList.add('kicking');
        }

        function copyCode() {
            navigator.clipboard.writeText(peer.id);
            alert("Copied Code!");
        }

    </script>
</body>
</html>
